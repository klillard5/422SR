var http = require('http');
var debug = process.env['HOP_DEBUG'] === 'TRUE' || false;

var HOPURL = debug
  ? 'localhost'
  : 'hopsocket-james.dotcloud.com';

var HOPPORT = debug
  ? 8080
  : 80;


module.exports = function(secretKey) {

  function xreq(method, resource, data, cb) {
    var xreq = http.request({
      hostname: HOPURL,
      port: HOPPORT,
      path: resource,
      method: method,
      headers: {
        'x-hop-secretkey': secretKey,
        'Content-Type': 'application/json'
      }
    });

    xreq.write(JSON.stringify(data),encoding='utf8');
    xreq.end();
  }

  return new (function() {
    var self = this;
    
    this.middleware = function(req, res, next) {
      var clientId = req.headers['x-hop-clientid'];
      var method = req.headers['x-hop-method'];
      
      res.hop = {
        client: {
          id: clientId
        },
        subscribe: function() {
          if(clientId) {
            var xreq = http.request({
              hostname: HOPURL,
              port: HOPPORT,
              path: req.path,
              method: 'GET',
              headers: {
                'x-hop-clientid': clientId,
                'x-hop-secretkey': secretKey
              }
            });
            xreq.end();
          }
        }
      }

      next();
    };

    this.put = function(resource, data) {
      xreq('PUT', resource, data);
    }

    this.post = function(resource, data) {
      xreq('POST', resource, data);
    }

    this.patch = function(resource, data) {
      xreq('PATCH', resource, data);
    }
  });
}